name: Download

# This workload downloads external dependencies (binaries)  and uploads them as artifacts,
# that can be used in other workflows.

permissions:
  contents: write

on:
  workflow_call:
    inputs:
      cedana_version:
        type: string
        description: Version for Cedana binaries (branch name, tag or "release" for latest release)
        required: false
        default: "none"
      criu_version:
        type: string
        description: Version for CRIU binaries (branch name, tag or "release" for latest release)
        required: false
        default: "none"
      gpu_version:
        type: string
        description: Version for GPU binaries (branch name, tag or "release" for latest release)
        required: false
        default: "none"
      streamer_version:
        type: string
        description: Version for streamer binaries (branch name, tag or "release" for latest release)
        required: false
        default: "none"
      controller_version:
        type: string
        description: Version for controller binaries (branch name, tag or "release" for latest release)
        required: false
        default: "none"
      containerd_runtime_version:
        type: string
        description: Version for containerd runtime binaries (branch name, tag or "release" for latest release)
        required: false
        default: "none"
      helm_chart_version:
        type: string
        description: Version for Cedana Helm chart (branch name, tag or "release" for latest release)
        required: false
        default: "none"

jobs:
  cedana:
    name: Cedana
    if: ${{ inputs.cedana_version != 'none' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        arch:
          - amd64
          - arm64
    steps:
      - name: Download cedana
        env:
          API_KEY: ${{ secrets.CLOUDSMITH_ENTITLEMENT_TOKEN }}
          VERSION: ${{ inputs.cedana_version == 'release' && 'latest' || inputs.cedana_version }}
          ARCH: ${{ matrix.arch }}
        run: |
          mkdir -p cedana
          cd cedana
          VERSION=$(echo $VERSION | sed 's/\//-/g')
          if [ "${VERSION#v}" != "$VERSION" ] || [ "$VERSION" = "latest" ]; then
            REPO="cedana/cedana"
          else
            REPO="cedana/cedana-alpha"
          fi
          URL1="https://dl.cloudsmith.io/${API_KEY}/${REPO}/raw/versions/${VERSION}/cedana-${ARCH}"
          URL2="https://dl.cloudsmith.io/${API_KEY}/${REPO}/raw/names/cedana-${ARCH}/versions/${VERSION}/cedana"

          # Try first URL, if 404 then try alternative URL
          if ! curl -1Lf -O "$URL1"; then
            echo "Primary URL failed, trying alternative URL..."
            curl -1Lf -o cedana-${ARCH} "$URL2"
          fi
          mv cedana-${ARCH} cedana
          echo $VERSION > cedana-version.txt

      - name: Upload cedana
        uses: actions/upload-artifact@v4
        with:
          name: cedana-${{ matrix.arch }}
          path: ./cedana/*

      - name: Get digest
        env:
          IMAGE_NAME: ${{ (inputs.cedana_version == 'release' || startsWith(inputs.cedana_version, 'v')) && 'cedana/cedana-helper' || 'cedana/cedana-helper-test' }}
          TAG: ${{ inputs.cedana_version == 'release' && 'latest' || inputs.cedana_version }}
        run: |
          mkdir -p /tmp/digests
          mkdir -p /tmp/image-name
          TAG=$(echo $TAG | sed 's/\//-/g')
          docker pull --platform=linux/${{ matrix.arch }} $IMAGE_NAME:$TAG
          digest=$(docker inspect --format='{{index .RepoDigests 0}}' $IMAGE_NAME:$TAG | cut -d'@' -f2)
          touch "/tmp/digests/${digest#sha256:}"
          echo "$IMAGE_NAME" > /tmp/image-name/name.txt

      - name: Upload digest
        uses: actions/upload-artifact@v4
        with:
          name: digests-${{ matrix.arch }}
          path: /tmp/digests/*
          if-no-files-found: error

      - name: Upload image name
        if: ${{ matrix.arch == 'amd64' }}
        uses: actions/upload-artifact@v4
        with:
          name: image-name
          path: /tmp/image-name/*
          if-no-files-found: error

  plugin:
    name: Plugin
    if: ${{ inputs.cedana_version != 'none' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        plugin:
          - runc
          - containerd
          - crio
          - kata
          - cloud-hypervisor
          - k8s
          - slurm
          - storage/cedana
          - storage/s3
          - storage/gcs
        arch:
          - amd64
          - arm64
    steps:
      - name: Set plugin name
        env:
          PLUGIN: ${{ matrix.plugin }}
        run: |
          PLUGIN=$(echo $PLUGIN | sed 's/\//-/g')
          echo "PLUGIN=$PLUGIN" >> $GITHUB_ENV

      - name: Download plugin
        env:
          API_KEY: ${{ secrets.CLOUDSMITH_ENTITLEMENT_TOKEN }}
          PLUGIN: ${{ env.PLUGIN }}
          VERSION: ${{ inputs.cedana_version == 'release' && 'latest' || inputs.cedana_version }}
          ARCH: ${{ matrix.arch }}
        run: |
          VERSION=$(echo $VERSION | sed 's/\//-/g')
          if [ "${VERSION#v}" != "$VERSION" ] || [ "$VERSION" = "latest" ]; then
            REPO="cedana/cedana"
          else
            REPO="cedana/cedana-alpha"
          fi
          URL1="https://dl.cloudsmith.io/${API_KEY}/${REPO}/raw/versions/${VERSION}/libcedana-${PLUGIN}.so-${ARCH}"
          URL2="https://dl.cloudsmith.io/${API_KEY}/${REPO}/raw/names/libcedana-${PLUGIN}.so-${ARCH}/versions/${VERSION}/libcedana-${PLUGIN}.so"

          # Try first URL, if 404 then try alternative URL
          if ! curl -1Lf -O "$URL1"; then
            echo "Primary URL failed, trying alternative URL..."
            curl -1Lf -o libcedana-${PLUGIN}.so-${ARCH} "$URL2"
          fi
          mv libcedana-${PLUGIN}.so-${ARCH} libcedana-${PLUGIN}.so
          echo $VERSION > plugins-version.txt

      - name: Upload plugin
        uses: actions/upload-artifact@v4
        with:
          name: plugin-${{ matrix.arch }}-${{ env.PLUGIN }}
          path: |
            ./libcedana-*.so
            ./plugin-version.txt

  criu:
    name: CRIU
    if: ${{ inputs.criu_version != 'none' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        arch:
          - amd64
          - arm64
    steps:
      - name: Download CRIU
        env:
          API_KEY: ${{ secrets.CLOUDSMITH_ENTITLEMENT_TOKEN }}
          VERSION: ${{ inputs.criu_version == 'release' && 'latest' || inputs.criu_version }}
          ARCH: ${{ matrix.arch }}
        run: |
          mkdir -p criu
          cd criu
          VERSION=$(echo $VERSION | sed 's/\//-/g')
          if [ "${VERSION#v}" != "$VERSION" ] || [ "$VERSION" = "latest" ]; then
            REPO="cedana/criu"
          else
            REPO="cedana/criu-alpha"
          fi
          URL1="https://dl.cloudsmith.io/${API_KEY}/${REPO}/raw/versions/${VERSION}/criu-${ARCH}"
          URL2="https://dl.cloudsmith.io/${API_KEY}/${REPO}/raw/names/criu-${ARCH}/versions/${VERSION}/criu"

          # Try first URL, if 404 then try alternative URL
          if ! curl -1Lf -O "$URL1"; then
            echo "Primary URL failed, trying alternative URL..."
            curl -1Lf -o criu-${ARCH} "$URL2"
          fi
          mv criu-${ARCH} criu
          echo $VERSION > criu-version.txt

      - name: Upload CRIU
        uses: actions/upload-artifact@v4
        with:
          name: criu-${{ matrix.arch }}
          path: ./criu/*

  gpu:
    name: GPU
    if: ${{ inputs.gpu_version != 'none' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        arch:
          - amd64
          - arm64
    steps:
      - name: Download binaries
        env:
          API_KEY: ${{ secrets.CLOUDSMITH_ENTITLEMENT_TOKEN }}
          VERSION: ${{ inputs.gpu_version == 'release' && 'latest' || inputs.gpu_version }}
          ARCH: ${{ matrix.arch }}
        run: |
          mkdir -p gpu
          cd gpu
          VERSION=$(echo $VERSION | sed 's/\//-/g')
          if [ "${VERSION#v}" != "$VERSION" ] || [ "$VERSION" = "latest" ]; then
            REPO="cedana/cedana-gpu"
          else
            REPO="cedana/cedana-gpu-alpha"
          fi

          # Download cedana-gpu-controller with fallback
          URL1="https://dl.cloudsmith.io/${API_KEY}/${REPO}/raw/versions/${VERSION}/cedana-gpu-controller-${ARCH}"
          URL2="https://dl.cloudsmith.io/${API_KEY}/${REPO}/raw/names/cedana-gpu-controller-${ARCH}/versions/${VERSION}/cedana-gpu-controller"
          if ! curl -1Lf -O "$URL1"; then
            echo "Primary URL failed for cedana-gpu-controller, trying alternative URL..."
            curl -1Lf -o cedana-gpu-controller-${ARCH} "$URL2"
          fi

          # Download libcedana-gpu.so with fallback
          URL1="https://dl.cloudsmith.io/${API_KEY}/${REPO}/raw/versions/${VERSION}/libcedana-gpu.so-${ARCH}"
          URL2="https://dl.cloudsmith.io/${API_KEY}/${REPO}/raw/names/libcedana-gpu.so-${ARCH}/versions/${VERSION}/libcedana-gpu.so"
          if ! curl -1Lf -O "$URL1"; then
            echo "Primary URL failed for libcedana-gpu.so, trying alternative URL..."
            curl -1Lf -o libcedana-gpu.so-${ARCH} "$URL2"
          fi

          # Download libcedana-gpu-tracer.so with fallback
          URL1="https://dl.cloudsmith.io/${API_KEY}/${REPO}/raw/versions/${VERSION}/libcedana-gpu-tracer.so-${ARCH}"
          URL2="https://dl.cloudsmith.io/${API_KEY}/${REPO}/raw/names/libcedana-gpu-tracer.so-${ARCH}/versions/${VERSION}/libcedana-gpu-tracer.so"
          if ! curl -1Lf -O "$URL1"; then
            echo "Primary URL failed for libcedana-gpu-tracer.so, trying alternative URL..."
            curl -1Lf -o libcedana-gpu-tracer.so-${ARCH} "$URL2"
          fi

          mv cedana-gpu-controller-${ARCH} cedana-gpu-controller
          mv libcedana-gpu.so-${ARCH} libcedana-gpu.so
          mv libcedana-gpu-tracer.so-${ARCH} libcedana-gpu-tracer.so
          echo $VERSION > gpu-version.txt

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gpu-${{ matrix.arch }}
          path: ./gpu/*

  streamer:
    name: Streamer
    if: ${{ inputs.streamer_version != 'none' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        arch:
          - amd64
          - arm64
    steps:
      - name: Download binaries
        env:
          API_KEY: ${{ secrets.CLOUDSMITH_ENTITLEMENT_TOKEN }}
          VERSION: ${{ inputs.streamer_version == 'release' && 'latest' || inputs.streamer_version }}
          ARCH: ${{ matrix.arch }}
        run: |
          mkdir -p streamer
          cd streamer
          VERSION=$(echo $VERSION | sed 's/\//-/g')
          if [ "${VERSION#v}" != "$VERSION" ] || [ "$VERSION" = "latest" ]; then
            REPO="cedana/cedana-image-streamer"
          else
            REPO="cedana/cedana-image-streamer-alpha"
          fi
          URL1="https://dl.cloudsmith.io/${API_KEY}/${REPO}/raw/versions/${VERSION}/cedana-image-streamer-${ARCH}"
          URL2="https://dl.cloudsmith.io/${API_KEY}/${REPO}/raw/names/cedana-image-streamer-${ARCH}/versions/${VERSION}/cedana-image-streamer"

          # Try first URL, if 404 then try alternative URL
          if ! curl -1Lf -O "$URL1"; then
            echo "Primary URL failed, trying alternative URL..."
            curl -1Lf -o cedana-image-streamer-${ARCH} "$URL2"
          fi
          mv cedana-image-streamer-${ARCH} cedana-image-streamer
          echo $VERSION > streamer-version.txt

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: streamer-${{ matrix.arch }}
          path: ./streamer/*

  controller:
    name: Controller
    if: ${{ inputs.controller_version != 'none' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        arch:
          - amd64
          - arm64
    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Get digest
        env:
          IMAGE_NAME: ${{ (inputs.controller_version == 'release' || startsWith(inputs.controller_version, 'v')) && 'cedana/cedana-controller' || 'cedana/cedana-controller-test' }}
          TAG: ${{ inputs.controller_version == 'release' && 'latest' || inputs.controller_version }}
        run: |
          mkdir -p /tmp/digests
          mkdir -p /tmp/image-name
          TAG=$(echo $TAG | sed 's/\//-/g')
          docker pull --platform=linux/${{ matrix.arch }} $IMAGE_NAME:$TAG
          digest=$(docker inspect --format='{{index .RepoDigests 0}}' $IMAGE_NAME:$TAG | cut -d'@' -f2)
          touch "/tmp/digests/${digest#sha256:}"
          echo "$IMAGE_NAME" > /tmp/image-name/name.txt

      - name: Upload digest
        uses: actions/upload-artifact@v4
        with:
          name: controller-digests-${{ matrix.arch }}
          path: /tmp/digests/*
          if-no-files-found: error

      - name: Upload image name
        if: ${{ matrix.arch == 'amd64' }}
        uses: actions/upload-artifact@v4
        with:
          name: controller-image-name
          path: /tmp/image-name/*
          if-no-files-found: error

  containerd-runtime-runc:
    name: Containerd Runtime
    if: ${{ inputs.containerd_runtime_version != 'none' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        arch:
          - amd64
          - arm64
    steps:
      - name: Download runtime binaries
        env:
          API_KEY: ${{ secrets.CLOUDSMITH_ENTITLEMENT_TOKEN }}
          VERSION: ${{ inputs.containerd_runtime_version == 'release' && 'latest' || inputs.containerd_runtime_version }}
          ARCH: ${{ matrix.arch }}
        run: |
          mkdir -p containerd-runtime-runc
          cd containerd-runtime-runc
          VERSION=$(echo $VERSION | sed 's/\//-/g')
          if [ "${VERSION#v}" != "$VERSION" ] || [ "$VERSION" = "latest" ]; then
            REPO="cedana/cedana-runtime-shim"
          else
            REPO="cedana/cedana-runtime-shim-alpha"
          fi
          URL1="https://dl.cloudsmith.io/${API_KEY}/${REPO}/raw/versions/${VERSION}/cedana-shim-runc-v2-${ARCH}"
          URL2="https://dl.cloudsmith.io/${API_KEY}/${REPO}/raw/names/cedana-shim-runc-v2-${ARCH}/versions/${VERSION}/cedana-shim-runc-v2"

          # Try first URL, if 404 then try alternative URL
          if ! curl -1Lf -O "$URL1"; then
            echo "Primary URL failed, trying alternative URL..."
            curl -1Lf -o cedana-shim-runc-v2-${ARCH} "$URL2"
          fi
          mv cedana-shim-runc-v2-${ARCH} cedana-shim-runc-v2
          echo $VERSION > containerd-runtime-version.txt
          cd -
          # TODO: Can add more runtimes here in the future

      - name: Upload runtime runc artifacts
        uses: actions/upload-artifact@v4
        with:
          name: containerd-runtime-${{ matrix.arch }}-runc
          path: ./containerd-runtime-runc/*

  helm-chart:
    name: Helm Chart
    if: ${{ inputs.helm_chart_version != 'none' }}
    runs-on: ubuntu-latest
    steps:
      - name: Get tag
        id: get_tag
        env:
          VERSION: ${{ inputs.helm_chart_version }}
        run: |
          if [ "$VERSION" = "release" ]; then
            tag=$(curl -s https://api.github.com/repos/cedana/cedana-helm-charts/releases/latest | jq -r .tag_name)
            echo "tag=$tag" >> $GITHUB_OUTPUT
          else
            echo "tag=$VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          repository: cedana/cedana-helm-charts
          ref: ${{ steps.get_tag.outputs.tag }}

      - name: Upload helm chart
        uses: actions/upload-artifact@v4
        with:
          name: helm-chart
          path: cedana-helm

