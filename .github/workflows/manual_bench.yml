name: Manual (bench)

on:
  workflow_dispatch:
    inputs:
      cedana_version:
        type: string
        description: Version for Cedana binaries (branch name or "release" for latest release)
        required: false
        default: "main"
      gpu_version:
        type: string
        description: Version for GPU binaries (branch name or "release" for latest release)
        required: false
        default: "main"
      streamer_version:
        type: string
        description: Version for streamer binaries (branch name or "release" for latest release)
        required: false
        default: "main"
      bench_cedana:
        type: boolean
        description: Run benchmarks for Cedana
        required: false
        default: false
      bench_native:
        type: boolean
        description: Run benchmarks for native
        required: false
        default: false
      bench_samples:
        type: number
        description: Number of samples to run for each metric
        required: false
        default: 2
      bench_push_results:
        type: boolean
        description: Push benchmark results to storage
        required: false
        default: false
      bench_comparison_patch:
        type: boolean
        description: Compare benchmark results with last patch
        required: false
        default: false
      bench_comparison_native:
        type: boolean
        description: Compare benchmark results with native
        required: false
        default: false
      bench_result_dataset:
        type: string
        description: "BigQuery dataset to push results to"
        required: false
        default: "cedana_alpha"
      runner_family:
        type: string
        description: "Runner family for benchmarks"
        required: false
        default: "g6-4xlarge"

jobs:
  download:
    name: Download
    uses: ./.github/workflows/download.yml
    secrets: inherit
    if: inputs.bench_cedana
    with:
      cedana_version: ${{ inputs.cedana_version }}
      gpu_version: ${{ inputs.gpu_version }}
      streamer_version: ${{ inputs.streamer_version }}

  bench:
    name: Bench
    uses: ./.github/workflows/bench.yml
    if: always() || github.event.inputs.bench_cedana || github.event.inputs.bench_native
    needs: [build, download]
    secrets: inherit
    with:
      cedana: ${{ inputs.bench_cedana }}
      native: ${{ inputs.bench_native }}
      samples: ${{ inputs.bench_samples }}
      push_results: ${{ inputs.bench_push_results }}
      comparison_patch: ${{ inputs.bench_comparison_patch }}
      comparison_native: ${{ inputs.bench_comparison_native }}
      result_dataset: ${{ inputs.bench_result_dataset }}
      runner_family: ${{ inputs.runner_family }}
